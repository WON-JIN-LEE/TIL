# SOP, CORS 이란?

## 📌 SOP(Single Origin Policy) - 동일 출처 정책
CORS가 왜 생겨났는지 알아보도록 하겠습니다.

SOP: 동일 출처 정책(same-origin policy)은 어떤 출처에서 불러온 문서나 스크립트가 다른 출처에서 가져온 리소스와 상호작용하는 것을 제한하는 **중요한 보안 방식**입니다. 동일 출처 정책은 잠재적으로 해로울 수 있는 문서를 분리함으로써 공격받을 수 있는 경로를 줄여줍니다.

브라우저는 기본적으로 오리진이 다를 경우, 스크립트의 실행을 제한합니다. 쉽게 말해서, 실수로 잘못 들어간 사이트에서 멋대로 코드를 실행하여 **쿠키 같은 개인정보나, 다른 사이트의 DOM 조작을 하지 못하도록 막을 수 있는 것**입니다.

이런 안전장치가 없을 때 일어날 수 있는 여러 이슈를 발생할 수 있기 때문에 이를 방지하기 위해서 SOP가 생겨났습니다. 이 때문에 우리는 서버가 응답을 보낼 때 CORS와 관련된 처리를 해줘합니다. 


## 📌 CORS (Cross-Origin Resource Sharing)
CORS는 이름에서 보이듯이 서버와 브라우저의 오리진이 다를 때 브라우저가 보낸 리소스 요청을 처리하는 메커니즘입니다. 기본적으로 브라우저와 서버의 오리진이 다르다면 브라우저는 서버가 보낸 리소스를 사용할 수 없습니다. 브라우저가 요청을 보내고, 이에 대해 서버가 보낸 응답의 http 헤더 중 Access-Control-Allow-Origin에 브라우저의 오리진이 포함되어있는지를 확인합니다. 만약 허용되지 않은 오리진이라면 우리는 위에서 본 빨간 오류 문구를 마주하게 됩니다.

### CORS의 작동 방식
1. 브라우저가 서버로 요청을 보낼 때, origin이 다른 경우 request header에 자신의 origin을 포함하여 보냅니다.
2. CORS 요청이 필요한 경우 브라우저에서는 간단한 요청(simple request)를 제외하고는 preflight request를 먼저 서버 측으로 보내서 유효한 응답이 오는지 먼저 확인합니다.
3. 확인은 응답 헤더의 Access-Control-Allow-Origin을 확인하는 등의 방법을 취하고, 이 헤더에 현 브라우저의 origin이 명시되어 있다면 유효한 요청으로 판단하여 CORS가 가능해집니다.

___
### Preflight Request
프리플라이트(Preflight) 방식은 일반적으로 우리가 웹 어플리케이션을 개발할 때 가장 마주치는 시나리오이다. 이 시나리오에 해당하는 상황일 때 브라우저는 요청을 한번에 보내지 않고 예비 요청과 본 요청으로 나누어서 서버로 전송한다.

이때 브라우저가 본 요청을 보내기 전에 보내는 예비 요청을 Preflight라고 부르는 것이며, 이 예비 요청에는 HTTP 메소드 중 OPTIONS 메소드가 사용된다. 예비 요청의 역할은 본 요청을 보내기 전에 브라우저 스스로 이 요청을 보내는 것이 안전한지 확인하는 것이다.

이 과정을 간단한 플로우 차트로 나타내보면 대략 이런 느낌이다.

![캡처](https://user-images.githubusercontent.com/46555489/164989881-9d1698ba-da2f-4543-a275-c0951916bb16.PNG)

- 실제로 브라우저가 보낸 요청을 보면, 단순히 Origin에 대한 정보 뿐만 아니라 자신이 예비 요청 이후에 보낼 본 요청에 대한 다른 정보들도 함께 포함되어 있는 것을 볼 수 있다.

- 이 예비 요청에서 브라우저는 Access-Control-Request-Headers를 사용하여 자신이 본 요청에서 Content-Type 헤더를 사용할 것을 알려줍니다.
- 그리고 Access-Control-Request-Method를 사용하여 이후 GET 메소드를 사용할 것을 서버에게 미리 알려주고 있는 것이다.

___
### Simple Request
단순 요청(Simple Request)은 예비 요청을 보내지 않고 바로 서버에게 본 요청부터 때려박은 후, 서버가 이에 대한 응답의 헤더에 Access-Control-Allow-Origin과 같은 값을 보내주면 그때 브라우저가 CORS 정책 위반 여부를 검사하는 방식이다. 즉, 프리플라이트와 단순 요청 시나리오는 전반적인 로직 자체는 같되, **예비 요청의 존재 유무만 다르다**.

![단순 요청은 예비 요청없이 바로 본 요청으로 퉁치는 시나리오이다](https://evan-moon.github.io/static/d8ed6519e305c807c687032ff61240f8/6af66/simple-request.png)

___
### Credentialed Request
Credentialed Request는 인증된 요청을 사용하는 방법이다. 이 방법은 CORS의 기본적인 방식이라기 보다는 다른 출처 간 통신에서 좀 더 보안을 강화하고 싶을 때 사용하는 방법이다. 좀 더 빡빡한 검사 조건을 추가하게 된다.

기본적으로 브라우저가 제공하는 비동기 리소스 요청 API인 XMLHttpRequest 객체나 fetch API는 별도의 옵션 없이 브라우저의 쿠키 정보나 인증과 관련된 헤더를 함부로 요청에 담지 않는다. 이때 요청에 인증과 관련된 정보를 담을 수 있게 해주는 옵션이 바로 **credentials 옵션**이다.

- 이처럼 요청에 인증 정보가 담겨있는 상태에서 다른 출처의 리소스를 요청하게 되면 브라우저는 CORS 정책 위반 여부를 검사하는 룰에 다음 두 가지를 추가하게 된다.
    - Access-Control-Allow-Origin에는 *를 사용할 수 없으며, 명시적인 URL이어야한다.
    - 응답 헤더에는 반드시 Access-Control-Allow-Credentials: true가 존재해야한다.